<script>
    const meta = [
        {
            "artist": "Spotify",
            "project": "Release Day",
            "director": "Jonatan Lopez"
        },
        {
            "artist": "J Balvin & Skrillex",
            "project": "In Da Getto",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Snoh Aalegra",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Meta",
            "project": "Pa Mi Gente",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Google Pixel",
            "project": "Feature Drop",
            "director": "Coryn Bajema"
        },
        {
            "artist": "Corona",
            "project": "La Vida Más Fina Es Nuestra",
            "director": "Leo Aguirre"
        },
        {
            "artist": "Billboard & Samsung",
            "project": "Lunay",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Cordae",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "NOIA x Buscabulla",
            "project": "Eclipse De Amor",
            "director": "Erin Vassilopoulos"
        },
        {
            "artist": "Beats x Chloe Bailey",
            "project": "Lock In Work Out",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Nike",
            "project": "",
            "director": "Somos Familia"
        },
        {
            "artist": "Havaianas x Barbie Ferreira",
            "project": "Barbie Ferreira",
            "director": "Klaudia Podsiadlo"
        },
        {
            "artist": "Anohni and The Johnsons",
            "project": "Why Am I Alive Now?",
            "director": "Hunter Schafer"
        },
        {
            "artist": "Cassie Marin",
            "project": "Tanto",
            "director": "Chistine Yuan"
        },
        {
            "artist": "Ninja",
            "project": "NeverStick Ceramic Pro",
            "director": "David Ma"
        },
        {
            "artist": "RZA x Ballantine's",
            "project": "Neighborhood",
            "director": "Autre Fish"
        },
        {
            "artist": "Bad Bunny x Spotify",
            "project": "Un Verano Sin Ti",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Spotify Frequency",
            "project": "Yendry",
            "director": "Dior Rodriguez"
        },
        {
            "artist": "Bad Bunny x Spotify",
            "project": "Un Verano Sin Ti",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Sech",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Tory Burch x Sydney Sweeney",
            "project": "Holiday Help",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Patrón Tequila",
            "project": "Gracias A La Vida",
            "director": "Leo Aguirre"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Rosalía",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Lisa ft Tyla",
            "project": "When I'm With You",
            "director": "Olivia de Camps"
        },
        {
            "artist": "Rosalía x Wisin & Yandel",
            "project": "Besos Moja2",
            "director": "Chistine Yuan"
        },
        {
            "artist": "Google Pixel",
            "project": "Love in Translation",
            "director": "Navs"
        },
        {
            "artist": "Golden Goose",
            "project": "Born to Be a Super-Star",
            "director": "Maik Schuster"
        },
        {
            "artist": "Omar Apollo x Kali Uchis",
            "project": "Bad Life",
            "director": "Alfred Marroquin & Omar Apollo"
        },
        {
            "artist": "Bad Bunny x Spotify",
            "project": "Un Verano Sin Ti",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Grimes",
            "project": "Player of Games",
            "director": "Anton Tammi"
        },
        {
            "artist": "Lord Jones x Flying Lotus",
            "project": "Sunday Bath Sessions",
            "director": "Jonatan Lopez"
        },
        {
            "artist": "Lila Drew Album Campaign",
            "project": "",
            "director": ""
        },
        {
            "artist": "Christina Aguilera  x Tini",
            "project": "Suéltame",
            "director": "Ana Lily Amirpour"
        },
        {
            "artist": "Lila Drew Album Campaign",
            "project": "",
            "director": ""
        },
        {
            "artist": "Chloe x Halle",
            "project": "Baby Girl",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Chloe x Halle",
            "project": "Ungodly Hour",
            "director": "Hufffman Creative"
        },
        {
            "artist": "Lila Drew Album Campaign",
            "project": "",
            "director": ""
        },
        {
            "artist": "Moullinex x GPU Panic",
            "project": "Inner Child",
            "director": "Daniel Soares"
        },
        {
            "artist": "Rauw Alejandro",
            "project": "Perreo Pesau",
            "director": "Alfready Marroquin"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Flo Milli",
            "director": "Navs"
        },
        {
            "artist": "Lila Drew Album Campaign",
            "project": "All The Places I Could Be",
            "director": "Vicent Haycock"
        },
        {
            "artist": "Rauw Alejandro",
            "project": "Dile a Él",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Orville Peck",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Lila Drew Album Campaign",
            "project": "",
            "director": ""
        },
        {
            "artist": "River Tiber",
            "project": "Hypnotized",
            "director": "Leo Aguirre"
        },
        {
            "artist": "Billboard x Honda Stage",
            "project": "Nathy Peluso",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Maxo x Pink Siifu",
            "project": "48",
            "director": "Vincent Haycock"
        },
        {
            "artist": "Billboard Honda Stage",
            "project": "Chloe x Halle",
            "director": "Alfred Marroquin"
        },
        {
            "artist": "Camila Cabello",
            "project": "CHANEL NO. 5",
            "director": "Paul Geusebroek"
        },
    ];

    function moveDot(clientX) {
        const rect = timeline.getBoundingClientRect();
        let x = clientX - rect.left;
        x = Math.max(0, Math.min(x, rect.width));
        const percent = (x / rect.width) * 100;
        dot.style.left = percent + '%';
    }

    let currentVideo = null;
    let originalContainer = null;
    let currentVideoIndex = 0;
    let globalMuted = false;


    function createModal() {
        const modal = document.createElement('div');
        modal.id = 'video-modal';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
        modal.style.display = 'none';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        modal.style.transition = 'opacity 0.3s ease';
        modal.style.opacity = '0';

        // Close Button
        const closeButton = document.createElement('span');
        closeButton.innerHTML = '<svg style="fill: white;" width="20px" height="20px" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><polygon points="864.29 361.11 718.89 215.71 540 394.6 361.11 215.71 215.71 361.11 394.61 540 215.71 718.89 361.11 864.29 540 685.39 718.89 864.29 864.29 718.89 685.39 540 864.29 361.11"/></svg>';
        closeButton.style.position = 'absolute';
        closeButton.style.top = '20px';
        closeButton.style.right = '20px';
        closeButton.style.cursor = 'pointer';
        closeButton.style.color = 'white';
        closeButton.style.fontSize = '24px';
        closeButton.style.zIndex = '10000';

        closeButton.addEventListener('click', closeModal);

        modal.appendChild(closeButton);

        // Control HTML
        const controlHTML = `<div style="display: flex; justify-content: space-between; align-items: center; font-size: 20px; height: 1em; margin-left: 25px; margin-right: 25px; gap: 2em; position: absolute; bottom: 25px; pointer-events: auto; z-index: 10; width: calc(100% - 50px);">
            <span style="width: 20%;" id="project-name"></span> 
            <span style="width: 15%;" id="director"></span> 
            <div id="timeline" style="position: relative; width: 25%; height: 4px; background: white; border-radius: 2px; cursor: pointer;">
                <div id="dot" style="position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%); width: 13px; height: 13px; background: white; border-radius: 50%; cursor: grab;"></div> 
            </div> 
            <div style="display: flex; gap: 2em; align-items: center;">
                <div id="backward" style="cursor: pointer; display: flex; align-items: center;">
                    <svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><polygon points="846.41 192.45 439.21 427.55 439.21 184.2 233.59 184.2 233.59 895.8 439.21 895.8 439.21 652.45 846.41 887.55 846.41 192.45"/></svg>
                </div> 
                <div id="play" style="cursor: pointer; display: flex; align-items: center;">
                    <svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><polygon points="840.98 540 239.02 192.45 239.02 887.55 840.98 540"/></svg>
                </div> 
                <div id="pause" style="cursor: pointer; display: flex; align-items: center;">
                    <svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><rect x="239.63" y="184.2" width="205.62" height="711.61"/><rect x="634.75" y="184.2" width="205.62" height="711.61"/></svg>
                </div> 
                <div id="forward" style="cursor: pointer; display: flex; align-items: center;"> 
                    <svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><polygon points="640.79 184.2 640.79 427.55 233.59 192.45 233.59 887.55 640.79 652.45 640.79 895.8 846.41 895.8 846.41 184.2 640.79 184.2"/></svg>
                </div> 
                <div id="mute" style="cursor: pointer; display: flex; align-items: center;">
                    <svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><path d="M850.43,602.93a237.74,237.74,0,0,0,9-65c0-91.77-52.05-171.26-128.16-210.93V483.78Z"/><path d="M731.28,658.83v90A239.09,239.09,0,0,0,784,711.54Z"/><rect x="517.87" y="13.69" width="123.78" height="1026.85" transform="translate(-202.92 564.34) rotate(-45)"/><polygon points="418.14 345.7 380.83 381.71 176.48 381.71 176.48 694.17 376.56 694.17 654.39 962.28 654.39 581.95 418.14 345.7"/><polygon points="654.39 406.9 654.39 117.72 507.23 259.73 654.39 406.9"/></svg>
                </div> 
            </div> 
        </div>`;
        modal.insertAdjacentHTML('beforeend', controlHTML);
        document.body.appendChild(modal);

        return modal;
    }

    // Create the modal once, and add button listeners once
    const modal = createModal();

    // Set up timeline and dot event listeners once
    const timeline = document.getElementById('timeline');
    const dot = document.getElementById('dot');
    let isDragging = false;

    dot.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isDragging = true;
        dot.style.cursor = 'grabbing';
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        dot.style.cursor = 'auto';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        moveDot(e.clientX);
    });

    timeline.addEventListener('click', (e) => {
        if (!currentVideo) return;
        const rect = timeline.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const percent = clickX / rect.width;
        currentVideo.currentTime = percent * currentVideo.duration;
        moveDot(e.clientX);
    });

    function closeModal() {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            if (originalContainer && currentVideo) {
                currentVideo.pause();  // Pause the video
                currentVideo.muted = true;  // Ensure the video is muted upon closing
                originalContainer.appendChild(currentVideo);
                currentVideo.style.width = '';   // Reset width
                currentVideo.style.height = '';  // Reset height
                currentVideo.style.maxWidth = '';   // Reset max-width
                currentVideo.style.maxHeight = '';  // Reset max-height
                currentVideo.style.marginTop = '';  // Reset margin
                currentVideo.removeEventListener('click', videoClickHandler);
            }
        }, 300);
    }

    modal.addEventListener('click', (e) => {
        if (e.target === modal) { // Close if click is outside the video
            closeModal();
        }
    });

    const videoClickHandler = (e) => {
        e.stopPropagation(); // Prevent the modal click event from being triggered
        if (currentVideo.paused) {
            currentVideo.play();
        } else {
            currentVideo.pause();
        }
    };

    const muteButton = document.getElementById('mute');
    muteButton.addEventListener('click', () => {
        if (currentVideo) {
            currentVideo.muted = !currentVideo.muted; // Toggle mute state
            globalMuted = currentVideo.muted;
            muteButton.innerHTML = globalMuted ? mutedIcon : unmutedIcon; // Update button icon
        }
    });

    const unmutedIcon = `<svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><polygon points="176.48 381.71 176.48 694.17 376.56 694.17 654.39 962.28 654.39 117.72 380.83 381.71 176.48 381.71"/><path d="M731.28,327V748.87c76.11-39.67,128.16-119.16,128.16-210.93S807.39,366.68,731.28,327Z"/></svg>`;
    const mutedIcon = `<svg style="fill: white;" width="1em" height="1em" id="Ebene_1" data-name="Ebene 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1080 1080"><path d="M850.43,602.93a237.74,237.74,0,0,0,9-65c0-91.77-52.05-171.26-128.16-210.93V483.78Z"/><path d="M731.28,658.83v90A239.09,239.09,0,0,0,784,711.54Z"/><rect x="517.87" y="13.69" width="123.78" height="1026.85" transform="translate(-202.92 564.34) rotate(-45)"/><polygon points="418.14 345.7 380.83 381.71 176.48 381.71 176.48 694.17 376.56 694.17 654.39 962.28 654.39 581.95 418.14 345.7"/><polygon points="654.39 406.9 654.39 117.72 507.23 259.73 654.39 406.9"/></svg>`;

    // Function gets called on video container click
    function onVideoContainerClick(event, video, container, resetTime) {
        if (originalContainer && currentVideo) {
            currentVideo.pause();  // Pause the video
            currentVideo.muted = true;  // Ensure the video is muted upon closing
            originalContainer.appendChild(currentVideo);
            currentVideo.style.width = '';   // Reset width
            currentVideo.style.height = '';  // Reset height
            currentVideo.style.maxWidth = '';   // Reset max-width
            currentVideo.style.maxHeight = '';  // Reset max-height
            currentVideo.style.marginTop = '';  // Reset margin
        }
        event.preventDefault();
        currentVideo = video;
        originalContainer = container; // Remember the original container
        modal.style.display = 'flex';

        setTimeout(() => {
            currentVideo.addEventListener('click', videoClickHandler);

            modal.style.opacity = '1';
            currentVideo.muted = globalMuted;
            muteButton.innerHTML = globalMuted ? mutedIcon : unmutedIcon;
            if (resetTime) {
                currentVideo.currentTime = 0;  // Reset the video to the beginning of forwared/backward
            }
            currentVideo.play();        // Play video in modal

            // Update the project name in the control bar
            document.getElementById('project-name').textContent = meta[currentVideoIndex].project;
            document.getElementById('director').textContent = meta[currentVideoIndex].director;
        }, 10);

        currentVideo.style.width = 'auto';
        currentVideo.style.height = 'auto';
        currentVideo.style.maxWidth = 'calc(100% - 50px)'; // Adjust for modal
        currentVideo.style.maxHeight = 'calc(100% - 115px)'; // Adjust for controls and padding
        currentVideo.style.marginTop = '-25px'; // Adjust for centering
        modal.appendChild(currentVideo);

        // Add video-specific timeupdate event listener

        currentVideo.addEventListener('timeupdate', () => {
            const percent = (currentVideo.currentTime / currentVideo.duration) * 100;
            dot.style.left = percent + '%';
        });
    }

    window.addEventListener('load', function () {
        // Initialize allVideoContainers with sorting by position
        let allVideoContainers = Array.from(document.querySelectorAll('.plyr__video-wrapper'))
            .sort((a, b) => {
                const rectA = a.getBoundingClientRect();
                const rectB = b.getBoundingClientRect();

                // Sort by Y first, then X
                if (rectA.top !== rectB.top) {
                    return rectA.top - rectB.top;
                }
                return rectA.left - rectB.left;
            });

        // Play button implementation
        const playButton = document.getElementById('play');
        playButton.addEventListener('click', () => {
            if (currentVideo) {
                currentVideo.play();
            }
        });

        // Pause button implementation
        const pauseButton = document.getElementById('pause');
        pauseButton.addEventListener('click', () => {
            if (currentVideo) {
                currentVideo.pause();
            }
        });

        forwardButton = document.getElementById('forward');
        forwardButton.addEventListener('click', (event) => {
            if (currentVideoIndex === allVideoContainers.length - 1) {
                currentVideoIndex = 0;
            } else {
                currentVideoIndex++;
            }
            onVideoContainerClick(event, allVideoContainers[currentVideoIndex].querySelector('video'), allVideoContainers[currentVideoIndex], true);
        });

        backwardButton = document.getElementById('backward');
        backwardButton.addEventListener('click', (event) => {
            if (currentVideoIndex === 0) {
                currentVideoIndex = allVideoContainers.length - 1;
            } else {
                currentVideoIndex--;
            }
            onVideoContainerClick(event, allVideoContainers[currentVideoIndex].querySelector('video'), allVideoContainers[currentVideoIndex], true);
        });

        console.log(allVideoContainers);

        allVideoContainers.forEach((container, index) => {
            const hoverText = document.createElement('div');
            hoverText.className = 'hover-text';

            // Create first line with heavy-font class
            const brandText = document.createElement('div');
            brandText.className = 'heavy-font';
            brandText.innerText = meta[index].artist;

            // Create second line
            const projectText = document.createElement('div');
            projectText.innerText = meta[index].project;

            // Add both elements to hover text
            hoverText.appendChild(brandText);
            hoverText.appendChild(projectText);

            hoverText.style.opacity = '0';
            hoverText.style.position = 'absolute';
            hoverText.style.bottom = '50%';
            hoverText.style.left = '50%';
            hoverText.style.transform = 'translate(-50%, 50%)';
            hoverText.style.pointerEvents = 'none';
            hoverText.style.zIndex = '10000';
            hoverText.style.textAlign = 'center';
            hoverText.style.transition = 'opacity 0.7s ease';
            hoverText.style.whiteSpace = 'nowrap';
            container.appendChild(hoverText);

            const video = container.querySelector('video');

            if (!video) return;

            container.addEventListener('mouseenter', () => {
                hoverText.style.opacity = '1';
                console.log("Play the fucking video", video);
                video.play();
            });
            container.addEventListener('mouseleave', () => {
                hoverText.style.opacity = '0';
                video.pause();
            });
            container.addEventListener('click', (event) => {
                currentVideoIndex = index;
                onVideoContainerClick(event, video, container);
            });
        });
    });
</script>